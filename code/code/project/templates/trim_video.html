{% extends "base.html" %}

{% block content %}
<h1>Video Editor</h1>

<form action="/upload_video" method="post" enctype="multipart/form-data" id="upload-form">
    <input type="file" name="videofile" accept="video/*" required>
    <button type="submit">Upload Video</button>
</form>

<!-- Display a message when the video is uploaded -->
<div id="upload-message" style="color: green;"></div>

<h2>Uploaded Videos:</h2>
<ul id="video-list">
    <!-- Display uploaded videos -->
</ul>

<h2>Trim Video:</h2>
<form id="trim-form">
    <label for="trim-start">Start Time (seconds):</label>
    <input type="number" id="trim-start" name="trim-start" required><br>

    <label for="trim-end">End Time (seconds):</label>
    <input type="number" id="trim-end" name="trim-end" required><br>

    <label for="trim-video">Select Video:</label>
    <select id="trim-video" name="trim-video" required>
        <!-- Populate with uploaded videos using JavaScript -->
    </select><br>

    <label for="trimmed-filename">Trimmed File Name:</label>
    <input type="text" id="trimmed-filename" name="trimmed-filename" required><br>

    <button type="button" onclick="trimVideo()">Trim Video</button>
</form>

<!-- Video player container -->
<div id="video-container" style="width: 320px; height: 240px; overflow: hidden;">
    <!-- Video player element -->
    <video id="video-player" controls style="width: 100%; height: 100%;">
        Your browser does not support the video tag.
    </video>
</div>

<!-- Play button for the selected video -->
<button id="play-button" onclick="playSelectedVideo()" disabled>Play Selected Video</button>

<script>
    // Dynamically update the list of uploaded videos
    fetch('/uploads')
        .then(response => response.json())
        .then(data => {
            const videoList = document.getElementById('video-list');
            const videoPlayer = document.getElementById('video-player');
            const playButton = document.getElementById('play-button');

            data.forEach(filename => {
                const listItem = document.createElement('li');
                listItem.textContent = filename;
                listItem.onclick = () => selectVideo(filename, playButton);
                videoList.appendChild(listItem);
            });

            // Populate trim select options
            const trimVideoSelect = document.getElementById('trim-video');

            data.forEach(filename => {
                const trimOption = document.createElement('option');
                trimOption.value = filename;
                trimOption.textContent = filename;
                trimVideoSelect.appendChild(trimOption);
            });
        });

    function trimVideo() {
        const trimForm = document.getElementById('trim-form');
        const formData = new FormData(trimForm);

        fetch('/edit_video/trim', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                videofile: formData.get('trim-video'),
                trim_start: formData.get('trim-start'),
                trim_end: formData.get('trim-end'),
                trimmed_filename: formData.get('trimmed-filename')  // New line
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
        });
    }

    function selectVideo(filename, playButton) {
        const videoPlayer = document.getElementById('video-player');
        const videoContainer = document.getElementById('video-container');
        const videoSource = `/playback/${filename}`;

        // Set the video source dynamically
        videoPlayer.src = videoSource;

        // Resize the video player container
        videoContainer.style.width = '320px'; // Set the desired width
        videoContainer.style.height = '240px'; // Set the desired height

        // Enable the play button
        playButton.disabled = false;
    }

    function playSelectedVideo() {
        const videoPlayer = document.getElementById('video-player');

        // Play the video
        videoPlayer.play();
    }

    // Update the upload form to handle the response
    const uploadForm = document.getElementById('upload-form');
    const uploadMessage = document.getElementById('upload-message');

    uploadForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(uploadForm);

        fetch('/upload_video', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.filename) {
                uploadMessage.style.color = 'green';
                uploadMessage.textContent = `Video "${data.filename}" successfully uploaded!`;
            } else if (data.error) {
                uploadMessage.style.color = 'red';
                uploadMessage.textContent = `Error: ${data.error}`;
            }
        })
        .catch(error => {
            uploadMessage.style.color = 'red';
            uploadMessage.textContent = `Error: ${error.message}`;
        });
    });
</script>
{% endblock %}
